var n = [
'#cec',
'#1d7',
'#1df',
'#c0d',
'#d00',
'#b63',
'#fe1',
'#8a8'
];

function r(d, e) {
    if (0 !== d.D) return !1;
    if (2 === e.length) {
        d.m = d.s + (~[0, 180].indexOf(e.a.rotation) ? 0 : 1);
        d.h = d.o + (~[0, 180].indexOf(e.a.rotation) ? 1 : 0);
        if (d.h >= this.a.g || d.h >= this.a.f) return !1;
        d.u = this.a.state[d.m][d.h];
        if (0 !== d.u) return !1
    }
    return !0
}

function t() {
    this.a = {
        state: []
    };
    this.reset();
    this.a.g = this.a.state.length;
    this.a.f = this.a.state[0].length
}

function u(d) {
    return d.a.state.map(function(d) {
        return d.reduce(function(d, e) {
            return Math.max(d, e)
        })
    }).reduce(function(d, g) {
        return Math.max(d, g)
    })
}
t.prototype.reset = function() {
    this.a.state = [
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0]
    ];
    return this
};

function v(d) {
    var e = (d.x || NaN) + 50 - 23;
    d = (d.y || NaN) + 50 - 37.237;
    return 23 < e && 297 > e && 37.237 < d && 311.237 > d ? [Math.floor((d - 37.237) / 274 * 5), Math.floor((e - 23) / 274 * 5)] : null
}

function w(d, e, g) {
    e = {
        s: e[0],
        o: e[1],
        D: d.a.state[e[0]][e[1]],
        m: NaN,
        h: NaN,
        u: NaN
    };
    var f = r.call(d, e, g);
    f && (d.a.state[e.s][e.o] = g.a.value[0], 2 === g.length && (d.a.state[e.m][e.h] = g.a.value[1]));
    return f
}

function x(d) {
    if (3 > d.length) return !1;
    var e = d.map(function(d) {
            return d.toString()
        }),
        g = [];
    d.forEach(function(d) {
        var h = d[0],
            l = d[1],
            k = l + 1,
            m = l + 1,
            p = h - 1,
            q = h + 1;
        0 <= p && ~e.indexOf([p, l].toString()) && g.push([d, [p, l]]);
        q < this.a.f && ~e.indexOf([q, l].toString()) && g.push([d, [q, l]]);
        m < this.a.g && ~e.indexOf([h, m].toString()) && g.push([d, [h, m]]);
        0 <= k && ~e.indexOf([h, k].toString()) && g.push([d, [h, k]])
    }.bind(this));
    g.map(function(d) {
        return d.map(function(d) {
            return d.toString()
        })
    });
    d = y.call(this, g);
    return !d[0] || d[0] && 3 > d[0].length ?
        !1 : d[0].map(function(d) {
            d = d.split(",");
            return [parseInt(d[0]), parseInt(d[1])]
        })
}

function y(d) {
    var e = d.map(function(d) {
            return d.filter(function(d, e, f) {
                return f.indexOf(d) == e
            }).sort().toString()
        }).filter(function(d, e, g) {
            return g.indexOf(d) == e
        }).map(function(d) {
            return d.match(/\d,\d/g)
        }),
        g = [];
    if (1 < e.length) {
        if (e.forEach(function(d, h) {
                e.forEach(function(e, k) {
                    h !== k && (~e.indexOf(d[0]) || ~e.indexOf(d[1])) && g.push(d.concat(e))
                })
            }), 0 <= z) return --z, y.call(this, g)
    } else return e;
    return g
}
var z = 10;

function A(d) {
    var e = {};
    d.a.state.forEach(function(d, f) {
        d.forEach(function(d, g) {
            0 !== d && (e[d] || (e[d] = []), e[d].push([f, g]))
        })
    });
    for (var g in e) {
        var f = x.call(d, e[g]);
        if (f) return f
    }
    return !1
}

function B(d) {
    for (var e = 0; e < d.a.g; e++)
        for (var g = d.a.state[e], f = 0; f < d.a.f; f++)
            if (0 === g[f] && (f + 1 < d.a.f && 0 === g[f + 1] || e + 1 < d.a.g && 0 === d.a.state[e + 1][f])) return !0;
    return !1
}

function C(d) {
    for (var e = 0; e < d.a.g; e++)
        for (var g = d.a.state[e], f = 0; f < d.a.f; f++)
            if (0 === g[f]) return !0;
    return !1
}

function D(d) {
    this.a = {
        value: null,
        C: d([
            [1],
            [2],
            [3],
            [4],
            [5],
            [6],
            [7],
            [2, 1],
            [3, 1],
            [4, 1],
            [5, 1],
            [6, 1],
            [3, 2],
            [4, 2],
            [5, 2],
            [6, 2],
            [4, 3],
            [5, 3],
            [6, 3],
            [5, 4],
            [6, 4],
            [6, 5]
        ]),
        x: NaN,
        y: NaN,
        offset: {
            x: NaN,
            y: NaN
        },
        width: NaN,
        height: NaN,
        rotation: 0
    };
    d = this.a.C;
    this.a.value = d[Math.floor(Math.random() * d.length)];
    this.length = this.a.value.length;
    E(this)
}

function E(d) {
    d.a.offset.x = 0;
    d.a.offset.y = 0;
    F(d)
}
D.prototype.get = function(d) {
    var e = this.a,
        g = {
            x: function() {
                return e.x - e.offset.x
            },
            y: function() {
                return e.y - e.offset.y
            },
            "default": function() {
                return e[d]
            }
        };
    return g[d] ? g[d]() : g["default"]()
};
D.prototype.rotate = function() {
    this.a.rotation = (this.a.rotation + 90) % 360;
    ~[0, 180].indexOf(this.a.rotation) && this.a.value.reverse();
    F(this);
    return this
};

function F(d) {
    var e = 1 === d.a.value.length ? 25 : 53;
    dSize = 1 === d.a.value.length ? 50 : 106;
    ~[90, 270].indexOf(d.a.rotation) ? (d.a.x = 135, d.a.y = 400 - e, d.a.width = 50, d.a.height = dSize) : (d.a.x = 160 - e, d.a.y = 375, d.a.width = dSize, d.a.height = 50)
}

function G(d) {
    var e = u(d.b),
        g = B(d.b),
        f = ~~e ? e : 2;
    return function(d) {
        return d.filter(function(d) {
            return 1 === d.length ? d[0] <= f : g && d[0] <= f && d[1] <= f
        })
    }
}

function H() {
    this.b = new t;
    this.a = {
        c: null,
        i: !1,
        l: !1
    };
    a.addEventListener("mousedown", this.w.bind(this));
    b.addEventListener("mouseup", this.B.bind(this));
    b.addEventListener("mousemove", this.A.bind(this));
    a.addEventListener("click", this.v.bind(this))
}
H.prototype.w = function(d) {
    d.preventDefault();
    var e = this.a.c.a,
        g = d.offsetX,
        f = d.offsetY,
        h = e.x,
        l = e.y,
        k = e.x + e.width,
        e = e.y + e.height;
    h < g && l < f && g < k && f < e && (this.a.i = !0, this.a.c.a.x = d.offsetX, this.a.c.a.y = d.offsetY, this.a.c.a.offset.x = g - h, this.a.c.a.offset.y = f - l, this.j());
    return this
};
H.prototype.B = function(d) {
    d.preventDefault();
    d = v({
        x: this.a.c.get("x"),
        y: this.a.c.get("y")
    });
    var e = this;
    if (d && w(this.b, d, this.a.c)) {
        for (var g, f; g = A(this.b);)
            if (g) {
                var h = e.b.a.state[g[0][0]][g[0][1]];
                f = d;
                2 === e.a.c.length && (~[0, 180].indexOf(e.a.c.get("rotation")) ? e.a.c.get("value")[1] === h && (f = [f[0], f[1] + 1]) : e.a.c.get("value")[1] === h && (f = [f[0] + 1, f[1]]));
                g.forEach(function(d) {
                    d.toString() === f.toString() ? e.b.a.state[f[0]][f[1]] += 1 : e.b.a.state[d[0]][d[1]] = 0;
                    7 < e.b.a.state[d[0]][d[1]] && (0 < f[0] - 1 && (0 < f[1] -
                        1 && (e.b.a.state[f[0] - 1][f[1] - 1] = 0), f[1] + 1 < e.b.a.f && (e.b.a.state[f[0] - 1][f[1] + 1] = 0), e.b.a.state[f[0] - 1][f[1]] = 0), f[0] + 1 < e.b.a.g && (0 < f[1] - 1 && (e.b.a.state[f[0] + 1][f[1] - 1] = 0), f[1] + 1 < e.b.a.f && (e.b.a.state[f[0] + 1][f[1] + 1] = 0), e.b.a.state[f[0] + 1][f[1]] = 0), 0 < f[1] - 1 && (e.b.a.state[f[0]][f[1] - 1] = 0), f[1] + 1 < e.b.a.f && (e.b.a.state[f[0]][f[1] + 1] = 0), e.b.a.state[f[0]][f[1]] = 0)
                })
            } else break;
        C(this.b) ? (delete this.a.c, this.a.c = new D(G(this))) : setTimeout(function() {
            alert("no moves left!");
            I(this)
        }.bind(this), 300)
    } else E(this.a.c);
    this.a.i = !1;
    this.j();
    return this
};
H.prototype.A = function(d) {
    this.a.i && (this.a.c.a.x = d.offsetX, this.a.c.a.y = d.offsetY, this.a.l = !0);
    return this
};
H.prototype.v = function(d) {
    d.preventDefault();
    this.a.l || this.a.c.rotate();
    this.a.l = !1;
    return this
};

function I(d) {
    d.b.reset();
    d.a.c = new D(G(d));
    d.j()
}
H.prototype.j = function() {
    function d() {
        c.fillStyle = "#FFF";
        c.fillRect(0, 0, 320, 480);
        e.b.a.state.forEach(function(d, e) {
            d.forEach(function(d, f) {
                var g = 23 + 50 * f + 6 * f,
                    h = 37.237 + 50 * e + 6 * e,
                    J = g + 19,
                    K = h + 33;
                c.fillStyle = n[d];
                c.fillRect(g, h, 50, 50);
                0 !== d && (c.font = "24px Arial", c.fillStyle = "#fff", c.fillText(d, J, K))
            })
        });
        var g = e.a.c,
            f = g.a.rotation;
        g.a.value.forEach(function(d, e) {
            var k = 56 * e,
                m = ~[90, 270].indexOf(f) ? 0 : k,
                m = g.get("x") + m,
                p = m + 19,
                k = ~[0, 180].indexOf(f) ? 0 : k,
                k = g.get("y") +
                k,
                q = k + 33;
            c.fillStyle = n[d];
            c.fillRect(m, k, 50, 50);
            c.font = "24px Arial";
            c.fillStyle = "#fff";
            c.fillText(d, p, q)
        });
        e.a.i && requestAnimationFrame(d)
    }
    var e;
    return function() {
        e = this;
        d();
        return this
    }
}();
I(new H);